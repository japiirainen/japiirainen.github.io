<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="/favicon.ico"><title>Typesafe express routes</title><meta name="title" content="Typesafe express routes"><meta name="description" content="Writing type-safe express routes using typera."><meta property="og:type" content="website"><meta property="og:url"><meta property="og:title" content="Typesafe express routes"><meta property="og:description" content="Writing type-safe express routes using typera."><meta property="og:image" content="https://astro.build/social.jpg?v=1"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url"><meta property="twitter:title" content="Typesafe express routes"><meta property="twitter:description" content="Writing type-safe express routes using typera."><meta property="twitter:image" content="https://astro.build/social.jpg?v=1"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&amp;family=IBM+Plex+Sans:wght@400;700&amp;display=swap"><link rel="stylesheet" href="/blog.css"><link rel="stylesheet" href="/_astro/common-m6xjp.css" type="text/css"></head><body><header class="layout astro-mYHAcGzO"><article class="astro-mYHAcGzO"><h1 class="astro-mYHAcGzO"><a href="/" class="astro-mYHAcGzO"><span class="astro-mYHAcGzO">Home</span></a></h1></article></header><div class="layout astro-eZ0V7RoP"><article class="content astro-eZ0V7RoP"><div class="astro-eZ0V7RoP"><header class="astro-eZ0V7RoP"><img width="720" height="420" class="hero-image astro-eZ0V7RoP" loading="lazy" src="https://images.unsplash.com/photo-1579241685990-ef3dc47cdee5?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=2364&amp;q=80" alt="Typesafe-Express"><p class="publish-date astro-eZ0V7RoP">Tuesday, June 8 2021</p><h1 class="title astro-eZ0V7RoP">Typesafe express routes</h1><div class="author astro-vgbcRyj4"><p class="astro-vgbcRyj4"><a href="https://github.com/japiirainen" class="astro-vgbcRyj4">@japiirainen</a></p></div></header><main class="astro-eZ0V7RoP"><p>Recently I’ve spent a lot of time writing Haskell. In Haskell-land there’s a lot of bleeding-edge research stuff, which is cool, but most likely not very applicable for my day-to-day work. If there’s one thing that all haskellers love, it must be type-safety. That’s what this post is about, bringing some type-safety to our node.js apps, more specifically express or koa apps. I’ll try to point to some flaws I see in the typical way of writing express/koa apps with typescript and propose a “better” way.</p><h2 id="motivating-example">Motivating example</h2><p>Let’s start by defining routes we would like to implement. Suppose you are writing some CRUD operations for some “users” resource. We will use the following endpoint schema as an example.</p><pre class=" language-html"><code class="language-html">GET /users     =&gt; Ok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>[User]</span><span class="token punctuation">&gt;</span></span>
GET /users/:id =&gt; Ok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span><span class="token punctuation">&gt;</span></span> | NotFound
POST /users    =&gt; Ok | BadRequest
PUT /users/:id =&gt; Ok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span><span class="token punctuation">&gt;</span></span> | BadRequest | NotFound
</code></pre><p>The example endpoints will be using this interface for querying a “database”. Implementation details of this interface are not relevant for this post. (There is a link at the end to a gist containing all the code in these examples.)</p><pre class=" language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">UsersRepo</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">all</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
  <span class="token function-variable function">findById</span><span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>User<span class="token operator">&gt;&gt;</span>
  <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Id<span class="token operator">&gt;</span>
  <span class="token function-variable function">update</span><span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> update<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>User<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="lets-write-some-express-endpoints">Let’s write some express endpoints</h3><p>Let’s start with the “GET all users” and “GET user by id” endpoints.</p><pre class=" language-ts"><code class="language-ts">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>_req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token operator">+</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNone</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>The “GET all users” endpoint is not so bad. There’s no risk for anything blowing up because of some type-error. The second endpoint is already starting to show some problems. By default request parameters captured by express is of type “string”, which is bad for us since our database interface requires the user’s id as a number. Nothing is validating that <em><strong>req.params.id</strong></em> is a number, so the conversion to number might throw. Also, nothing is checking that the id is even present in “req.params”.</p><p>Next, we’ll look at our POST and PUT endpoints. These start to show the issues I’m trying to highlight.</p><pre class=" language-ts"><code class="language-ts">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body <span class="token comment">// req bodys type is any. This line also throws if name is not present in req.body</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNone</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params <span class="token comment">// req.params is of type any. Also throws in case id is missing in req.params.</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token operator">+</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token comment">// same problem again with req.body</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNone</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>I documented some of the problems with code comments. There are also some more nuanced issues I see here. Nothing is checking what status codes we are returning or validating checking that the JSON we are sending is of type User. We could return an elephant instead of a user and the type-system wouldn’t notice a thing. These are not very big problems in this contrived example but I hope you get the point.</p><p>Let’s consider the following change in our UsersRepo interface.</p><pre class=" language-ts"><code class="language-ts">Interface UsersRepo <span class="token punctuation">{</span>
  <span class="token function-variable function">all</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// changes to  ⬇️</span>

Interface UsersRepo <span class="token punctuation">{</span>
  <span class="token function-variable function">all</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><p>So now for whatever reason, our all users action returns Option of User. What kind of type errors do we get? Is our code going to compile?</p><p>Unfortunately yes. Typescript says everything is fine. Hopefully, our test coverage catches these kinds of mistakes, but in my opinion, this should never get through the compilation step.</p><h2 id="how-can-we-improve-from-this">How can we improve from this?</h2><p>Luckily we are not doomed. There are better ways to do this. I will be using this awesome open-source library called typera. You can use it on top of either express or koa. I’m going to use it with express so I’ll add “typera-express” to my package.json and add the following imports.</p><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Route<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> Parser<span class="token punctuation">,</span> route<span class="token punctuation">,</span> router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typera-express'</span>
</code></pre><p>Here is the “GET all users” endpoint rewritten with typera.</p><pre class=" language-ts"><code class="language-ts"><span class="token keyword">const</span> users<span class="token operator">:</span> Route<span class="token operator">&lt;</span>Response<span class="token punctuation">.</span>Ok<span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> route
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Response<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>Compare it to the previous implementation. Do you see any improvements?</p><pre class=" language-ts"><code class="language-ts">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>_req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>In this simple endpoint, the benefits are not huge, but there are some improvements. First of all, you can see what the endpoint is capable of returning, in this case, <em><strong>Response.Ok User</strong></em>. Also, note the usage of <em><strong>Response.ok()</strong></em> instead of <em><strong>res.json().status(200)</strong></em>. This makes our job easier since we don’t need to think about the status codes we’re returning, thus reducing the chance of us writing bugs.</p><p>Here’s the “update user” endpoint rewritten with typera.</p><pre class=" language-ts"><code class="language-ts"><span class="token keyword">const</span> updateUser<span class="token operator">:</span> Route<span class="token operator">&lt;</span>
  Response<span class="token punctuation">.</span>Ok<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token operator">|</span> Response<span class="token punctuation">.</span>NotFound <span class="token operator">|</span> Response<span class="token punctuation">.</span>BadRequest<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> <span class="token operator">=</span> route
  <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id(int)'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Parser<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> body<span class="token punctuation">,</span> routeParams<span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> updatedM <span class="token operator">=</span> <span class="token keyword">await</span> usersRepo<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">.</span><span class="token function">isNone</span><span class="token punctuation">(</span>updatedM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">notFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>updatedM<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>There’s a lot going on, so let’s break it down.</p><pre class=" language-ts"><code class="language-ts">Route<span class="token operator">&lt;</span>Response<span class="token punctuation">.</span>Ok User <span class="token operator">|</span> Response<span class="token punctuation">.</span>NotFound <span class="token operator">|</span> Response<span class="token punctuation">.</span>BadRequest <span class="token builtin">string</span><span class="token operator">&gt;</span>
</code></pre><p>We list the possible return values of our endpoint.</p><pre class=" language-ts"><code class="language-ts"><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id(int)'</span><span class="token punctuation">)</span>
</code></pre><p>This line is interesting. Typera calls these param conversions. Typera will validate that the “id” in query parameter is of type int and return BadRequest in the case this requirement is not met.</p><pre class=" language-ts"><code class="language-ts"><span class="token function">use</span><span class="token punctuation">(</span>Parser<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>This line takes care of request body validation. You can use any valid io-ts validation schemas with typera. If you are unfamiliar with io-ts, I highly recommend checking it out!</p><p>Now the handler function we get the validated and correctly typed request body and query parameters.</p><p>That’s a huge improvement compared to the initial version. After embracing the power type-safety gives you, just looking at the initial version is giving me headaches. I know this toy example is not the perfect way to motivate you to introduce this complexity to your codebase since you start seeing the benefits when your application gets bigger and you need to start making changes. The point I’m trying to make is that I think static types and type-safety make your code better, cleaner, and most importantly more maintainable.</p><p>Hope you learned something from this post. Cheers!</p><h4 id="links">Links</h4><ul><li><a href="https://github.com/akheron/typera">typera</a></li><li><a href="https://gist.github.com/japiirainen/5061fd58d5a7d52f535fb053f99d3bc9">example source of the typera version</a></li><li><a href="https://github.com/japiirainen">my github</a></li></ul></main></div></article></div></body></html>