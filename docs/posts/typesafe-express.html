<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Blog - Typesafe express routes</title>
    <link rel="stylesheet" type="text/css" href="../css/composeconference.css" />
  </head>
  <body>
    <header>
      <div class="heading">
        <div class="logo">
          <div style="float: left"></div>
          <div>
            <a href="../">japiirainen</a>
          </div>
        </div>
        <nav><a href="../">home</a> <a href="../about.html">about</a></nav>
      </div>
    </header>

    <main class="markdown-body" role="main">
      <h1>Typesafe express routes</h1>
      <div class="info">
  <em>Posted on June  8, 2021  by Joona </em><br /><br />
</div>

<p>Recently I’ve spent a lot of time writing Haskell. In Haskell-land there’s a lot of bleeding-edge research stuff, which is cool, but most likely not very applicable for my day-to-day work. If there’s one thing that all haskellers love, it must be type-safety. That’s what this post is about, bringing some type-safety to our node.js apps, more specifically express or koa apps. I’ll try to point to some flaws I see in the typical way of writing express/koa apps with typescript and propose a “better” way.</p>
<h2 id="motivating-example">Motivating example</h2>
<p>Let’s start by defining routes we would like to implement. Suppose you are writing some CRUD operations for some “users” resource. We will use the following endpoint schema as an example.</p>
<pre><code>GET /users     =&gt; Ok&lt;[User]&gt;
GET /users/:id =&gt; Ok&lt;User&gt; | NotFound
POST /users    =&gt; Ok | BadRequest
PUT /users/:id =&gt; Ok&lt;User&gt; | BadRequest | NotFound</code></pre>
<p>The example endpoints will be using this interface for querying a “database”. Implementation details of this interface are not relevant for this post. (There is a link at the end to a gist containing all the code in these examples.)</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> UsersRepo {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  all<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>User[]<span class="op">&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  findById<span class="op">:</span> (id<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User<span class="op">&gt;&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  create<span class="op">:</span> (name<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>Id<span class="op">&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  update<span class="op">:</span> (id<span class="op">:</span> Id<span class="op">,</span> update<span class="op">:</span> { name<span class="op">:</span> <span class="dt">string</span> }) <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User<span class="op">&gt;&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="lets-write-some-express-endpoints">Let’s write some express endpoints</h3>
<p>Let’s start with the “GET all users” and “GET user by id” endpoints.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">'/users'</span><span class="op">,</span> <span class="kw">async</span> (_req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">all</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>(users)<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">'/users/:id'</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">findById</span>(<span class="op">+</span>req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isNone</span>(user)) <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>(user<span class="op">.</span><span class="at">value</span>)<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>The “GET all users” endpoint is not so bad. There’s no risk for anything blowing up because of some type-error. The second endpoint is already starting to show some problems. By default request parameters captured by express is of type “string”, which is bad for us since our database interface requires the user’s id as a number. Nothing is validating that <strong><em>req.params.id</em></strong> is a number, so the conversion to number might throw. Also, nothing is checking that the id is even present in “req.params”.</p>
<p>Next, we’ll look at our POST and PUT endpoints. These start to show the issues I’m trying to highlight.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/users'</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { name } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span> <span class="co">// req bodys type is any. This line also throws if name is not present in req.body</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> id <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">create</span>(name)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">findById</span>(id)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isNone</span>(user)) <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>(user<span class="op">.</span><span class="at">value</span>)<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">put</span>(<span class="st">'/users/:id'</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { id } <span class="op">=</span> req<span class="op">.</span><span class="at">params</span> <span class="co">// req.params is of type any. Also throws in case id is missing in req.params.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">update</span>(<span class="op">+</span>id<span class="op">,</span> req<span class="op">.</span><span class="at">body</span>) <span class="co">// same problem again with req.body</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isNone</span>(user)) <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">json</span>(user<span class="op">.</span><span class="at">value</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>I documented some of the problems with code comments. There are also some more nuanced issues I see here. Nothing is checking what status codes we are returning or validating checking that the JSON we are sending is of type User. We could return an elephant instead of a user and the type-system wouldn’t notice a thing. These are not very big problems in this contrived example but I hope you get the point.</p>
<p>Let’s consider the following change in our UsersRepo interface.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>Interface UsersRepo {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  all<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>User[]<span class="op">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">// changes to  ⬇️</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>Interface UsersRepo {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  all<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User[]<span class="op">&gt;&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>So now for whatever reason, our all users action returns Option of User. What kind of type errors do we get? Is our code going to compile?</p>
<p>Unfortunately yes. Typescript says everything is fine. Hopefully, our test coverage catches these kinds of mistakes, but in my opinion, this should never get through the compilation step.</p>
<h2 id="how-can-we-improve-from-this">How can we improve from this?</h2>
<p>Luckily we are not doomed. There are better ways to do this. I will be using this awesome open-source library called typera. You can use it on top of either express or koa. I’m going to use it with express so I’ll add “typera-express” to my package.json and add the following imports.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Route<span class="op">,</span> Response<span class="op">,</span> Parser<span class="op">,</span> route<span class="op">,</span> router } <span class="im">from</span> <span class="st">'typera-express'</span></span></code></pre></div>
<p>Here is the “GET all users” endpoint rewritten with typera.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> users<span class="op">:</span> Route<span class="op">&lt;</span>Response<span class="op">.</span><span class="at">Ok</span><span class="op">&lt;</span>User[]<span class="op">&gt;&gt;</span> <span class="op">=</span> route</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">get</span>(<span class="st">'/users'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">handler</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> Response<span class="op">.</span><span class="fu">ok</span>(<span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">all</span>()))</span></code></pre></div>
<p>Compare it to the previous implementation. Do you see any improvements?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">'/users'</span><span class="op">,</span> <span class="kw">async</span> (_req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">all</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>(users)<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>In this simple endpoint, the benefits are not huge, but there are some improvements. First of all, you can see what the endpoint is capable of returning, in this case, <strong><em>Response.Ok User</em></strong>. Also, note the usage of <strong><em>Response.ok()</em></strong> instead of <strong><em>res.json().status(200)</em></strong>. This makes our job easier since we don’t need to think about the status codes we’re returning, thus reducing the chance of us writing bugs.</p>
<p>Here’s the “update user” endpoint rewritten with typera.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> updateUser<span class="op">:</span> Route<span class="op">&lt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  Response<span class="op">.</span><span class="at">Ok</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="op">|</span> Response<span class="op">.</span><span class="at">NotFound</span> <span class="op">|</span> Response<span class="op">.</span><span class="at">BadRequest</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="op">=</span> route</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">put</span>(<span class="st">'/users/:id(int)'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">use</span>(Parser<span class="op">.</span><span class="fu">body</span>(t<span class="op">.</span><span class="fu">type</span>({ name<span class="op">:</span> t<span class="op">.</span><span class="at">string</span> })))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">handler</span>(<span class="kw">async</span> ({ body<span class="op">,</span> routeParams<span class="op">:</span> { id } }) <span class="kw">=&gt;</span> {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> updatedM <span class="op">=</span> <span class="cf">await</span> usersRepo<span class="op">.</span><span class="fu">update</span>(id<span class="op">,</span> body)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (O<span class="op">.</span><span class="fu">isNone</span>(updatedM)) <span class="cf">return</span> Response<span class="op">.</span><span class="fu">notFound</span>()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Response<span class="op">.</span><span class="fu">ok</span>(updatedM<span class="op">.</span><span class="at">value</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
<p>There’s a lot going on, so let’s break it down.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Route<span class="op">&lt;</span>Response<span class="op">.</span><span class="at">Ok</span> User <span class="op">|</span> Response<span class="op">.</span><span class="at">NotFound</span> <span class="op">|</span> Response<span class="op">.</span><span class="at">BadRequest</span> <span class="dt">string</span><span class="op">&gt;</span></span></code></pre></div>
<p>We list the possible return values of our endpoint.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">put</span>(<span class="st">'/users/:id(int)'</span>)</span></code></pre></div>
<p>This line is interesting. Typera calls these param conversions. Typera will validate that the “id” in query parameter is of type int and return BadRequest in the case this requirement is not met.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">use</span>(Parser<span class="op">.</span><span class="fu">body</span>(t<span class="op">.</span><span class="fu">type</span>({ name<span class="op">:</span> t<span class="op">.</span><span class="at">string</span> })))</span></code></pre></div>
<p>This line takes care of request body validation. You can use any valid io-ts validation schemas with typera. If you are unfamiliar with io-ts, I highly recommend checking it out!</p>
<p>Now the handler function we get the validated and correctly typed request body and query parameters.</p>
<p>That’s a huge improvement compared to the initial version. After embracing the power type-safety gives you, just looking at the initial version is giving me headaches. I know this toy example is not the perfect way to motivate you to introduce this complexity to your codebase since you start seeing the benefits when your application gets bigger and you need to start making changes. The point I’m trying to make is that I think static types and type-safety make your code better, cleaner, and most importantly more maintainable.</p>
<p>Hope you learned something from this post. Cheers!</p>
<h4 id="links">Links</h4>
<ul>
<li><a href="https://github.com/akheron/typera">typera</a></li>
<li><a href="https://gist.github.com/japiirainen/5061fd58d5a7d52f535fb053f99d3bc9">example source of the typera version</a></li>
<li><a href="https://github.com/japiirainen">my github</a></li>
</ul>

    </main>

    <footer>
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a> | Source code is available
      at
      <a href="https://github.com/japiirainen/japiirainen.github.io">GitHub</a>
    </footer>
  </body>
</html>
