<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Joona Piirainen - Functional Dependency Injection</title>
    <link rel="stylesheet" type="text/css" href="../css/composeconference.css" />

    <!-- favicon stuff-->
    <link rel="icon" type="image/x-icon" href="../favicon.ico" />
  </head>
  <body>
    <header>
      <div class="heading">
        <div class="logo">
          <div style="float: left"></div>
          <div>
            <a href="../">japiirainen</a>
          </div>
        </div>
        <nav><a href="../">home</a> <a href="../about.html">about</a></nav>
      </div>
    </header>

    <main class="markdown-body" role="main">
      <h1>Functional Dependency Injection</h1>
      <div class="info">
  <em>Posted on April  8, 2022  by Joona </em><br /><br />
</div>

<p>Let’s talk about functions! We all love functions, right? Well at least I do, I write tens of them every day! I have been a TypeScript programmer in my day job for the last 1,5 years, and would like to share some practices I have seen work, and others that.. well.. suck.</p>
<p>Today I want to talk about the problem of global configuration in a backend application.</p>
<h2 id="global-configuration">Global configuration</h2>
<p>Typically you see global configuration represented as an ordinary object. When I say global configuration this can mean constants like port, host and also system wide dependencies such as a database connection or even some state, such as the currently active user.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Config <span class="op">=</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// configuration constants</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  port<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  host<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// so called &quot;dependencies&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  db<span class="op">:</span> { getUserByUserName<span class="op">:</span> (userName<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">&lt;</span>User<span class="op">&gt;</span> }<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  logger<span class="op">:</span> { info<span class="op">:</span> (s<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> <span class="dt">void</span> }<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// state variables</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  currentUserName<span class="op">:</span> Option<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> config<span class="op">:</span> Config <span class="op">=</span> {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  port<span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">PORT</span> <span class="op">??</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  host<span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">HOST</span> <span class="op">??</span> <span class="st">&quot;localhost&quot;</span><span class="op">,</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  db<span class="op">:</span> { getUserByUserName<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>({ name<span class="op">:</span> <span class="st">&quot;some user&quot;</span> }) }<span class="op">,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  logger<span class="op">:</span> { info<span class="op">:</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span> }<span class="op">,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  currentUserName<span class="op">:</span> O<span class="op">.</span><span class="fu">some</span>(<span class="st">&quot;some user&quot;</span>)<span class="op">,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>The most naive and unfortunately the most common way to consume global dependencies is something along the lines of the following code snippet.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetchUserNaive <span class="op">=</span> ()<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User<span class="op">&gt;&gt;</span> <span class="kw">=&gt;</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { db<span class="op">,</span> logger<span class="op">,</span> currentUserName } <span class="op">=</span> config<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">pipe</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    currentUserName<span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    O<span class="op">.</span><span class="fu">fold</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>(O<span class="op">.</span><span class="at">none</span>)<span class="op">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      (userName) <span class="kw">=&gt;</span> {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span>(<span class="vs">`fetching user with userName: </span><span class="sc">${</span>userName<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> db<span class="op">.</span><span class="fu">getUserByUserName</span>(userName)<span class="op">.</span><span class="fu">then</span>(O<span class="op">.</span><span class="at">some</span>)<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hasAuthNaive <span class="op">=</span> ()<span class="op">:</span> <span class="dt">boolean</span> <span class="kw">=&gt;</span> O<span class="op">.</span><span class="fu">isSome</span>(config<span class="op">.</span><span class="at">currentUserName</span>)<span class="op">;</span></span></code></pre></div>
<p>Why is this so bad you might ask. Well:</p>
<ul>
<li><p>Function inpurity:</p>
<p>Pure functions (functions that only depend on it’s input parameters and have no side-effects) are a lot easier to reason about and compose. Functions that read/manipulate global state are inherently impure. Yuk.</p></li>
<li><p>Makes program state unpredictable:</p>
<p>If a global configuration object is being used all over the application in a language that is not pure, there’s no guarantee that the object is not being mutated. This implies that the program’s behaviour can change radically from the global configuration getting mutated.</p></li>
<li><p>Mocking in tests becomes hard:</p>
<p>Providing different mock implementations for different tests is hard / error-prone.</p></li>
<li><p>Concurrency issues:</p>
<p>Not a problem in a single-threaded environment such as NodeJs, but anywhere else sharing mutable global state requires some kind of locking, which adds considerably more complexity to your code.</p></li>
<li><p>Code comprehension:</p>
<p>Code behaviour that depends on a lot of mutable global variables is hard to understand.</p></li>
</ul>
<p>Luckily improving from this is relatively simple. Let me introduce you to…</p>
<h2 id="function-parameters">Function parameters</h2>
<p>So the idea is to not depend on any values outside of our functions parameters, this forces us to list all of the dependencies the function has. When adapted to this style the previous code becomes:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetchUserParams <span class="op">=</span> (cfg<span class="op">:</span> Config)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User<span class="op">&gt;&gt;</span> <span class="kw">=&gt;</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { db<span class="op">,</span> logger<span class="op">,</span> currentUserName } <span class="op">=</span> cfg<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">pipe</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    currentUserName<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    O<span class="op">.</span><span class="fu">fold</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>(O<span class="op">.</span><span class="at">none</span>)<span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      (userName) <span class="kw">=&gt;</span> {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span>(<span class="vs">`fetching user with userName: </span><span class="sc">${</span>userName<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> db<span class="op">.</span><span class="fu">getUserByUserName</span>(userName)<span class="op">.</span><span class="fu">then</span>(O<span class="op">.</span><span class="at">some</span>)<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hasAuthParams<span class="op">:</span> (currentUserName<span class="op">:</span> Option<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span>) <span class="kw">=&gt;</span> <span class="dt">boolean</span> <span class="op">=</span> O<span class="op">.</span><span class="at">isSome</span><span class="op">;</span></span></code></pre></div>
<p>Ahh, this is so much better. But why…, well let’s see what kind of improvements we get to the list of issues from before.</p>
<ul>
<li><p>Function inpurity:</p>
<p>The purity of this function is now dependent on what <code>db.getUserByUserName</code> does. We can assume that it queries the database and thus is impure. But we have eliminated the impurities that were caused by depending on values outside of the functions paramers.</p></li>
<li><p>Global shared state Makes program state unpredictable:</p>
<p>We are no longer using global shared state.</p></li>
<li><p>Mocking in tests becomes hard:</p>
<p>It suddenly became easy.</p></li>
<li><p>Concurrency issues:</p>
<p>No longer a problem.</p></li>
<li><p>Code comprehension:</p>
<p>Readibility increases significantly, when you can see the dependencies of the functions from it’s type signature (parameters in this case).</p></li>
</ul>
<h3 id="is-this-dependency-injection">Is this dependency injection?</h3>
<p>Pretty much, it is a really basic application of dependency injection or inversion of control for backend development. Especially in a functional language or style we don’t normally talk about dependency injection. But the idea is the same. In fact this kind of pattern in functional programming has been noticed a long time ago. We can abstract over passing configuration to our functions with the <code>Reader</code> data type.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetchUserReader<span class="op">:</span> Reader<span class="op">&lt;</span>Config<span class="op">,</span> <span class="bu">Promise</span><span class="op">&lt;</span>Option<span class="op">&lt;</span>User<span class="op">&gt;&gt;&gt;</span> <span class="op">=</span> <span class="fu">pipe</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  R<span class="op">.</span><span class="fu">ask</span><span class="op">&lt;</span>Config<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  R<span class="op">.</span><span class="fu">map</span>(({ currentUserName<span class="op">,</span> db<span class="op">,</span> logger }) <span class="kw">=&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pipe</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      currentUserName<span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      O<span class="op">.</span><span class="fu">fold</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>(O<span class="op">.</span><span class="at">none</span>)<span class="op">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        (userName) <span class="kw">=&gt;</span> {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>          logger<span class="op">.</span><span class="fu">info</span>(<span class="vs">`fetching user with userName: </span><span class="sc">${</span>userName<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> db<span class="op">.</span><span class="fu">getUserByUserName</span>(userName)<span class="op">.</span><span class="fu">then</span>(O<span class="op">.</span><span class="at">some</span>)<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">// This is a bit silly, I would probably leave this to the version without the reader</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hasAuthReader<span class="op">:</span> Reader<span class="op">&lt;</span><span class="bu">Pick</span><span class="op">&lt;</span>Config<span class="op">,</span> <span class="st">&quot;currentUserName&quot;</span><span class="op">&gt;,</span> <span class="dt">boolean</span><span class="op">&gt;</span> <span class="op">=</span> <span class="fu">pipe</span>(</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  R<span class="op">.</span><span class="fu">ask</span><span class="op">&lt;</span><span class="bu">Pick</span><span class="op">&lt;</span>Config<span class="op">,</span> <span class="st">&quot;currentUserName&quot;</span><span class="op">&gt;&gt;</span>()<span class="op">,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  R<span class="op">.</span><span class="fu">map</span>(({ currentUserName }) <span class="kw">=&gt;</span> O<span class="op">.</span><span class="fu">isSome</span>(currentUserName))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<p>Without going to the detail you can think of the <code>Reader&lt;Config, string&gt;</code> as an abstraction for the following function <code>(config: Config) =&gt; string</code>. So it’s just a function in disquise!</p>
<p>This is a bit silly in this context, since the example is so simple but in principle here’s a couple of reasons you might consider the <code>Reader</code> data type.</p>
<ul>
<li>Abstracting over function parameters can be useful to avoid the issue of passing the configuration object to every function as a parameter.</li>
<li>It can make code more readable. Goes kind of hand in hand with the previous point. (readibility is in the eye of the reader ;-))</li>
</ul>
<p>Personally I propably wouldn’t introduce the <code>Reader</code> monad in a client project, since it can scare some people off and doesn’t bring enought benefits in the context of TypeScript to justify the costs (complexity, well again it’s in the eye of the reader).</p>
<h3 id="footnotes">Footnotes:</h3>
<ul>
<li><p>The <code>Option</code> and <code>Reader</code> data types I used in this post are from <a href="https://github.com/gcanti/fp-ts">fp-ts</a>.</p></li>
<li><p>If you want to see how <code>Reader</code> is used in haskell and other similar languages here is the blog post that introduced the <a href="https://www.fpcomplete.com/blog/2017/06/readert-design-pattern/"><code>ReaderT</code></a> pattern.</p></li>
</ul>

    </main>

    <footer>
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a> | Source code is available
      at
      <a href="https://github.com/japiirainen/japiirainen.github.io">GitHub</a>
    </footer>
  </body>
</html>
